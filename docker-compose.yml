# ─────────────────────────────────────────────────────────────────────────────
# docker-compose.yml — Local development / testing
#
# Usage:
#   docker compose build --build-arg VITE_APP_SECRET=$APP_SECRET
#   docker compose up
#
# The app is available at http://localhost:3000
# No HTTPS — use this for local-machine testing only.
# For internet-facing deployment with automatic HTTPS, use docker-compose.prod.yml
# ─────────────────────────────────────────────────────────────────────────────
services:
  finsurf:
    build:
      context: .
      # Bakes VITE_APP_SECRET into the Vite bundle so the frontend sends
      # the correct Authorization header to the Express API middleware.
      args:
        VITE_APP_SECRET: ${APP_SECRET:-}
    ports:
      - "${PORT:-3000}:3000"
    env_file: .env
    environment:
      NODE_ENV: production
      TELEMETRY_DB: /app/data/finsurf_telemetry.db
    volumes:
      # Named volume persists both the telemetry DB and the future MemorySaver DB
      # across container restarts and image rebuilds.
      - finsurf_data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r=>r.ok?process.exit(0):process.exit(1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

volumes:
  finsurf_data:
    driver: local
