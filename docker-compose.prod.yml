# ─────────────────────────────────────────────────────────────────────────────
# docker-compose.prod.yml — Internet-facing deployment with automatic HTTPS
#
# Prerequisites:
#   1. A domain pointing to this server's public IP (A/AAAA record).
#   2. Ports 80 and 443 open in your firewall / security group.
#   3. DOMAIN set in your .env (e.g. DOMAIN=finsurf.example.com)
#
# Usage (first run — provisions the Let's Encrypt certificate):
#   docker compose -f docker-compose.prod.yml up -d
#
# Caddy automatically renews the certificate before expiry — no cron needed.
# ─────────────────────────────────────────────────────────────────────────────
services:
  finsurf:
    build:
      context: .
      args:
        VITE_APP_SECRET: ${APP_SECRET:-}
    # Do NOT expose port 3000 to the host — only Caddy can reach it internally.
    expose:
      - "3000"
    env_file: .env
    environment:
      NODE_ENV: production
      TELEMETRY_DB: /app/data/finsurf_telemetry.db
      # Lock CORS to the production domain so other origins are rejected.
      CORS_ORIGIN: https://${DOMAIN}
    volumes:
      - finsurf_data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://localhost:3000/health').then(r=>r.ok?process.exit(0):process.exit(1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  caddy:
    image: caddy:2-alpine
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"  # HTTP/3
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data        # Stores TLS certificates (persists across restarts)
      - caddy_config:/config
    depends_on:
      finsurf:
        condition: service_healthy
    restart: unless-stopped

volumes:
  finsurf_data:
    driver: local
  caddy_data:
    driver: local
  caddy_config:
    driver: local
